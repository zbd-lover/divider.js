<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <script src="./divider.js"></script>
  <script>
    // Sequence source usage example
    
    // In the folloing example, cause we operate it directly, the data is "mutable mode".
    // you can use "immutable mode", it's entirely up to you.

    const makeProcessor = () => {
      const data = [
        {
          id: 1,
          name: "person1",
          age: 123,
          color: "red"
        }
      ];

      const add = (obj) => {
        let sum = 0;
        for (let i = 1; i < 500000; i++) {
          sum += 2;
        }
        data.push(obj);
      }

      const del = (payload) => {
        let index = data.findIndex((o) => o.id === payload.id);
        if (index >= 0) {
          data.splice(index, 1);
        }
      }

      const query = () => data;

      return (action, notify) => {
        let { type, payload } = action;
        switch (type) {
          case 'add':
            add(payload);
            break;
          case 'del':
            del(payload);
            break;
          default:
            break;
        }
        notify(query());
      }
    }

    const source = divider.createSource(makeProcessor());
    const { hook, addTaskListener: subscribe, createDispatch } = source;

    // Cause source is sequence, we just create the dispatch once.
    const dispatch = createDispatch();

    hook(dispatch, 0, () => {
      console.log('starts calc');
    });

    hook(dispatch, 1, () => {
      console.log('ends cacl');
    });

    subscribe("add", (d) => {
      console.log('datasource:', d);
    });

    subscribe("del", (d, action) => {
      console.log(`${action.payload.id} was deleted.`)
    });

    dispatch({
      type: "add",
      payload: {
        id: 5,
        name: "1132",
      }
    });

    setTimeout(() => {
      // remove hook by setting 'fn' null explicitly 
      hook(dispatch, 1, null);
      dispatch({
        type: "del",
        payload: {
          id: 2,
        }
      });
      setTimeout(delDispatch({id: 5}), 500);
    }, 500);

    const delDispatch = createDispatch("del");

    hook(delDispatch, 0, () => {
      console.log("I separates with hook for other dispatchs.");
    });

  </script>
</body>

</html>