<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <script src="./divider.js"></script>
  <script>

    // Sequence source usage example

    // In the folloing example, cause we operate it directly, the data is "mutable mode".
    // you can use "immutable mode", it's entirely up to you.

    const makeProcessor = () => {
      const data = [
        {
          id: 1,
          name: "person1",
          age: 123,
          color: "red"
        }
      ];

      const add = (obj) => {
        let sum = 0;
        for (let i = 1; i < 500000; i++) {
          sum += 2;
        }
        data.push(obj);
      }

      const del = (payload) => {
        let index = data.findIndex((o) => o.id === payload.id);
        if (index >= 0) {
          data.splice(index, 1);
        }
      }

      const query = () => data;

      return (action, notify) => {
        let { type, payload } = action;
        switch (type) {
          case 'create':
            add(payload);
            break;
          case 'del':
            del(payload);
            break;
          default:
            break;
        }
        notify(query());
      }
    }


    const source = divider.createSource(makeProcessor());
    const { observe, createDispatch, reset } = source;

    // observes all action. 
    observe(0, (action) => {
      console.log('action:', action);
    });

    const create = createDispatch('create');

    // observes specific action.
    observe('create', 0, () => {
      console.log('starts calc');
    });

    observe('create', 1, () => {
      console.log('ends cacl');
      console.log('----------');
    });

    // Param of dispatch is called 'payload'.
    create({
      id: 5,
      name: "1132",
    });

    setTimeout(() => {
      create({
        id: 5,
        name: "1132",
      });

      setTimeout(() => {
        delDispatch({ id: 5 });
      }, 500);
    }, 500);

    const delDispatch = createDispatch("del");

    observe("del", 0, () => {
      console.log("I separates with hook for other dispatchs.");
      reset();
      setTimeout(() => {
        create({
          id: 10,
          name: "123"
        })
      }, 500)
    });


  </script>
</body>

</html>