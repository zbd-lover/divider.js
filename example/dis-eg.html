<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <script src="./divider.js"></script>
  <script>
    const makeProcessor = () => {
      const add = (obj) => {
        return new Promise((rs, rj) => {
          setTimeout(() => rs('added ok!'), 500);
        })
      }

      const del = (payload) => {
        return new Promise((rs, rj) => {
          setTimeout(() => rs('added ok!'), 750);
        });
      }

      const query = () => {
        return new Promise((rs, rj) => {
          setTimeout(() => rs({
            data: 123,
            success: true
          }), 1000);
        })
      }

      // async processor need promise the 'notify' called after your async op;
      const processor = async (action, notify) => {
        let { type, payload } = action;
        switch (type) {
          case 'create':
            await add(payload);
            break;
          case 'del':
            del(payload).then(async (rs) => {
              notify(await query());
            });
            return;
          default:
            break;
        }
        // program will throw error in 4.5 seconds.
        notify(await query());
      }

      return (action, notify) => {
        processor(action, notify);
      }
    }

    // discrete
    const source = divider.createSource(makeProcessor(), true);
    const { observe, createDispatch, interrupt } = source;

    observe("interrupt", (name) => {
      console.log(`${name} is interrupted. public`);
    })

    observe("before", (action) => {
      console.log(`I am ${action.type}, go to working.`)
    })

    const dispatchAdd = createDispatch('add');
    const dispatchDel = createDispatch('del');

    observe("add", 0, (action) => {
      console.log('add1');
    })

    observe("add", 1, (d, a) => {
      console.log('add action result:', d);
    });

    observe("add", "interrupt", (name) => {
      console.log(`${name} is interrupted. private`);
    });

    observe("del", 1, (d) => {
      console.log('deleted ok!');
    })

    dispatchAdd({ id: 11 });
    // interrupt("add");

    setTimeout(() => {
      dispatchAdd({ id: 11 });
      interrupt("add");

      setTimeout(() => {
        dispatchDel({ id: 11 });
        interrupt("del");
      }, 1000);
    }, 200);

    // setTimeout(() => interrupt("add"), 1000)
  </script>
</body>

</html>